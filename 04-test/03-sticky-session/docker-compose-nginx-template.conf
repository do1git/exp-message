upstream backend {
  # ip_hashÎ°ú Sticky Session ÏÑ§Ï†ï (WebSocket Ïó∞Í≤∞ Ïú†ÏßÄ)
  ip_hash;
  
  server app:8080 max_fails=3 fail_timeout=30s;
  server app:8080 max_fails=3 fail_timeout=30s;
  # docker-compose scale Ïãú ÏûêÎèôÏúºÎ°ú Ï∂îÍ∞ÄÎêòÎäî Ïù∏Ïä§ÌÑ¥Ïä§Îì§
}

log_format upstream_log '$remote_addr - $remote_user [$time_local] '
                            '"$request" $status $body_bytes_sent '
                            'upstream: $upstream_addr '    # üëà ÌïµÏã¨: Ïã§Ï†ú Ïó∞Í≤∞Îêú ÏÑúÎ≤Ñ IP
                            'status: $upstream_status '    # Î∞±ÏóîÎìúÏùò ÏùëÎãµ ÏΩîÎìú
                            'rt: $request_time '           # Ï†ÑÏ≤¥ ÏöîÏ≤≠ ÏãúÍ∞Ñ
                            'urt: $upstream_response_time'; # Î∞±ÏóîÎìú ÏùëÎãµ ÏãúÍ∞Ñ

server {
  listen 80;
  server_name _;

  set_real_ip_from 0.0.0.0/0; 
  real_ip_header X-Forwarded-For;
  real_ip_recursive on;
  
  access_log /dev/stdout upstream_log;

  # WebSocket ÏóîÎìúÌè¨Ïù∏Ìä∏
  location ${APP_PATH_PREFIX}/ws {
    # ÎÑ§Ìä∏ÏõåÌÅ¨ ÏßÄÏó∞ ÏãúÎÆ¨Î†àÏù¥ÏÖò
    access_by_lua_block {
      local delay_ms = ${NETWORK_DELAY_MS}
      if delay_ms > 0 then
        ngx.sleep(delay_ms / 1000)
      end
    }
    
    rewrite ^${APP_PATH_PREFIX}(.*)$ $1 break;
    proxy_pass http://backend;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    # WebSocket ÏµúÏ†ÅÌôî ÏÑ§Ï†ï
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection upgrade;
    proxy_read_timeout 86400s;
    proxy_send_timeout 86400s;
  }
  
  # ÏùºÎ∞ò REST API ÏóîÎìúÌè¨Ïù∏Ìä∏
  location ${APP_PATH_PREFIX} {
    # ÎÑ§Ìä∏ÏõåÌÅ¨ ÏßÄÏó∞ ÏãúÎÆ¨Î†àÏù¥ÏÖò
    access_by_lua_block {
      local delay_ms = ${NETWORK_DELAY_MS}
      if delay_ms > 0 then
        ngx.sleep(delay_ms / 1000)
      end
    }
    
    rewrite ^${APP_PATH_PREFIX}(.*)$ $1 break;
    proxy_pass http://backend;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Server $host;
    proxy_set_header X-Forwarded-Prefix ${APP_PATH_PREFIX};
    
    # ÏùºÎ∞ò HTTP ÏÑ§Ï†ï
    proxy_http_version 1.1;
    proxy_set_header Connection '';
    proxy_read_timeout 30s;
  }
}
