#!/bin/sh
# pre-push: run check (detekt + ktlintCheck + test) before push

# 색상: TTY이고 Windows(Git Bash 등)가 아닐 때만 ANSI 사용.
# Windows에서는 이스케이프 문자가 그대로 출력되거나 깨질 수 있음.
use_color=0
if [ -t 1 ] && [ "${TERM:-dumb}" != "dumb" ]; then
  case "$(uname -s 2>/dev/null)" in
    MINGW*|MSYS*|CYGWIN*) ;;
    *) use_color=1 ;;
  esac
fi

if [ "$use_color" = 1 ]; then
  RED='\033[0;31m'
  GREEN='\033[0;32m'
  YELLOW='\033[1;33m'
  CYAN='\033[0;36m'
  BOLD='\033[1m'
  RESET='\033[0m'
else
  RED=''
  GREEN=''
  YELLOW=''
  CYAN=''
  BOLD=''
  RESET=''
fi

cd 02-backend/00-monolitic || exit 1

./gradlew clean

echo ""
echo "${BOLD}━━━ Pre-push checks (02-backend/00-monolitic) ━━━${RESET}"
echo ""

# 1. Detekt
echo "${BOLD}[1/3] Detekt${RESET}"
if ./gradlew detekt; then
  echo "${GREEN}  ✓ detekt passed${RESET}"
  echo ""
else
  echo "${RED}  ✗ detekt failed${RESET}"
  echo ""
  echo "${YELLOW}  위 로그의 파일 경로와 규칙명을 보고 코드를 수정한 뒤,${RESET}"
  echo "  ./gradlew detekt  로 확인 후 다시 push 하세요."
  echo ""
  exit 1
fi

# 2. ktlintCheck
echo "${BOLD}[2/3] Kotlin format (ktlintCheck)${RESET}"
if ./gradlew ktlintCheck; then
  echo "${GREEN}  ✓ ktlintCheck passed${RESET}"
  echo ""
else
  echo "${RED}  ✗ ktlintCheck failed${RESET}"
  echo ""
  echo "${YELLOW}  포맷 자동 수정: ./gradlew ktlintFormat${RESET}"
  echo "  변경 파일 스테이징 후 다시 push 하세요."
  echo ""
  exit 1
fi

# 3. Test
echo "${BOLD}[3/3] Test${RESET}"
if ./gradlew test; then
  echo "${GREEN}  ✓ test passed${RESET}"
  echo ""
else
  echo "${RED}  ✗ test failed${RESET}"
  echo ""
  echo "${YELLOW}  1. 현재 환경에 도커가 설치되어 있는지 확인하세요 (테스트 시 필요).${RESET}"
  echo ""
  echo "${YELLOW}  2. 다음 경로의 index.html을 브라우저로 열어 에러 리포트를 확인하세요:${RESET}"
  echo "     $(pwd)/build/reports/tests/test/index.html"
  echo ""
  echo "${YELLOW}  3. ./gradlew test 로 다시 결과를 확인한 뒤, 수정 후 push 하세요.${RESET}"
  echo "     단위만: ./gradlew unitTest   전체: ./gradlew test"
  echo ""
  exit 1
fi

echo "${GREEN}✓ All checks passed. Good to push.${RESET}"
echo ""
exit 0
